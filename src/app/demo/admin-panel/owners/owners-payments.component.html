<div class="page-container owners-payments">
  <!-- Header avec navigation -->
  <section class="page-header">
    <div class="page-header__left">
      <button class="icon-button ghost" type="button" (click)="back()" aria-label="Retour">
        <span class="icon-chevron-left">‚Üê</span>
      </button>
      <div>
        <h1>Paiements des propri√©taires</h1>
        <p>Suivez les encaissements et commissions par propri√©taire</p>
      </div>
    </div>
    <div class="page-header__right" *ngIf="selectedOwner">
      <button class="btn btn-outline" type="button" (click)="viewOwnerDetails()">
        Voir le profil
      </button>
      <button class="btn btn-primary" type="button" (click)="exportPayments()">
        Exporter les donn√©es
      </button>
    </div>
  </section>

  <!-- Filtres avanc√©s -->
  <section class="content-wrapper">
    <div class="filters-card card">
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Propri√©taire</label>
          <select 
            class="modern-select" 
            [(ngModel)]="selectedOwnerId" 
            (change)="onOwnerChange(selectedOwnerId)">
            <option [ngValue]="undefined">Tous les propri√©taires</option>
            <option *ngFor="let owner of owners" [ngValue]="owner.id">
              {{ owner.name }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">P√©riode</label>
          <select 
            class="modern-select" 
            [(ngModel)]="selectedPeriod" 
            (change)="onPeriodChange(selectedPeriod)">
            <option value="">Toutes les p√©riodes</option>
            <option *ngFor="let period of periods" [value]="period">
              {{ period }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Statut</label>
          <select 
            class="modern-select" 
            [(ngModel)]="statusFilter" 
            (change)="onStatusChange(statusFilter)">
            <option *ngFor="let option of statusOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Mode de paiement</label>
          <select 
            class="modern-select" 
            [(ngModel)]="paymentMethodFilter" 
            (change)="onPaymentMethodChange(paymentMethodFilter)">
            <option *ngFor="let option of paymentMethodOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <div class="filter-group search-group">
          <label class="filter-label">Recherche</label>
          <div class="search-field">
            <input
              type="text"
              placeholder="Locataire, appartement, b√¢timent..."
              [ngModel]="searchTerm"
              (ngModelChange)="onSearchChange($event)" />
            <span class="icon-search">üîç</span>
          </div>
        </div>

        <div class="filter-actions">
          <button 
            class="btn btn-ghost" 
            type="button" 
            (click)="resetFilters()"
            [disabled]="!hasActiveFilters">
            R√©initialiser
          </button>
          <button 
            class="btn btn-outline" 
            type="button" 
            (click)="refreshData()">
            <span class="icon-refresh">üîÑ</span>
            Actualiser
          </button>
        </div>
      </div>

      <!-- Indicateur de filtres actifs -->
      <div class="active-filters" *ngIf="hasActiveFilters">
        <div class="filters-tags">
          <span class="filter-tag" *ngIf="selectedPeriod">
            P√©riode: {{ selectedPeriod }}
            <button (click)="selectedPeriod = ''; applyFilters()">√ó</button>
          </span>
          <span class="filter-tag" *ngIf="statusFilter">
            Statut: {{ getStatusText(statusFilter) }}
            <button (click)="statusFilter = ''; applyFilters()">√ó</button>
          </span>
          <span class="filter-tag" *ngIf="paymentMethodFilter">
            Mode: {{ paymentMethodFilter }}
            <button (click)="paymentMethodFilter = ''; applyFilters()">√ó</button>
          </span>
          <span class="filter-tag" *ngIf="searchTerm">
            Recherche: "{{ searchTerm }}"
            <button (click)="searchTerm = ''; applyFilters()">√ó</button>
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- Cartes de statistiques -->
  <section class="content-wrapper stats-grid" *ngIf="!loading">
    <article 
      class="stat-card" 
      *ngFor="let card of dashboardCards" 
      [ngClass]="card.accent">
      <div class="stat-card__label">{{ card.label }}</div>
      <div class="stat-card__value">{{ card.value }}</div>
      <div class="stat-card__meta">
        <span>{{ card.subLabel }}</span>
        <small *ngIf="card.trend">{{ card.trend }}</small>
      </div>
    </article>
  </section>

  <!-- √âtats de chargement et erreurs -->
  <section class="content-wrapper" *ngIf="loading">
    <div class="loading-state card">
      <div class="loading-spinner"></div>
      <p>Chargement des paiements...</p>
    </div>
  </section>

  <section class="content-wrapper" *ngIf="errorMessage && !loading">
    <div class="error-state card">
      <div class="error-icon">‚ö†</div>
      <h3>Erreur de chargement</h3>
      <p>{{ errorMessage }}</p>
      <button class="btn btn-primary" (click)="refreshData()">R√©essayer</button>
    </div>
  </section>

  <!-- Contenu principal -->
  <section class="content-wrapper main-layout" *ngIf="!loading && !errorMessage">
    
    <!-- Tableau des paiements -->
    <div class="main-panel card">
      <div class="card-header">
        <div class="header-content">
          <div>
            <h2>Historique des paiements</h2>
            <p *ngIf="selectedOwner">
              Paiements pour {{ selectedOwner.name }} ‚Ä¢ {{ filteredPayments.length }} r√©sultat(s)
            </p>
            <p *ngIf="!selectedOwner">
              Tous les paiements ‚Ä¢ {{ filteredPayments.length }} r√©sultat(s)
            </p>
          </div>
          <div class="header-actions">
            <button 
              class="btn btn-ghost" 
              type="button"
              [disabled]="filteredPayments.length === 0">
              {{ filteredPayments.length }} paiement(s)
            </button>
          </div>
        </div>
      </div>

      <div class="card-body">
        <div class="table-responsive">
          <table class="data-table payments-table">
            <thead>
              <tr>
                <th class="sortable" (click)="sortPayments('period')">
                  <span>P√©riode</span>
                  <span class="sort-indicator">‚Üï</span>
                </th>
                <th>Locataire</th>
                <th>Logement</th>
                <th class="sortable" (click)="sortPayments('amount')">
                  <span>Montant</span>
                  <span class="sort-indicator">‚Üï</span>
                </th>
                <th>Commission</th>
                <th>Mode</th>
                <th class="sortable" (click)="sortPayments('paymentDate')">
                  <span>Date</span>
                  <span class="sort-indicator">‚Üï</span>
                </th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody>
              <tr 
                *ngFor="let payment of filteredPayments" 
                class="clickable-row"
                (click)="viewPaymentDetails(payment)"
                [ngClass]="'row-' + payment.status">
                <td>
                  <div class="period-cell">
                    <strong>{{ payment.period }}</strong>
                    <small>{{ payment.collectorName }}</small>
                  </div>
                </td>
                <td>
                  <div class="tenant-cell">
                    <div class="tenant-avatar">
                      {{ getInitials(payment.tenantName) }}
                    </div>
                    <div class="tenant-info">
                      <strong>{{ payment.tenantName }}</strong>
                      <small>{{ payment.buildingName }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="property-cell">
                    <strong>{{ payment.apartmentName }}</strong>
                    <small>{{ payment.buildingName }}</small>
                  </div>
                </td>
                <td>
                  <div class="amount-cell">
                    <strong>{{ formatCurrency(payment.amount) }}</strong>
                    <small>Net: {{ formatCurrency(payment.netProprietaire || 0) }}</small>
                  </div>
                </td>
                <td>
                  <div class="commission-cell">
                    <span class="commission-amount">
                      {{ formatCurrency(payment.commissionRecouvreur || 0) }}
                    </span>
                    <small *ngIf="payment.amount && payment.amount > 0">
                      {{ ((payment.commissionRecouvreur || 0) / payment.amount * 100).toFixed(1) }}%
                    </small>
                  </div>
                </td>
                <td>
                  <span class="payment-method-badge">
                    {{ payment.paymentMethod }}
                  </span>
                </td>
                <td>
                  <div class="date-cell">
                    <strong>{{ formatDate(payment.paymentDate) }}</strong>
                    <small>{{ formatTime(payment.paymentDate) }}</small>
                  </div>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="payment.statusClass">
                    {{ payment.statusText }}
                  </span>
                </td>
              </tr>
              
              <tr *ngIf="filteredPayments.length === 0">
                <td colspan="8">
                  <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <h4>Aucun paiement trouv√©</h4>
                    <p *ngIf="hasActiveFilters">
                      Aucun r√©sultat ne correspond √† vos crit√®res de filtrage.
                    </p>
                    <p *ngIf="!hasActiveFilters">
                      Aucun paiement n'a √©t√© enregistr√© pour le moment.
                    </p>
                    <button 
                      class="btn btn-outline" 
                      *ngIf="hasActiveFilters"
                      (click)="resetFilters()">
                      R√©initialiser les filtres
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="table-footer" *ngIf="filteredPayments.length > 0">
          <div class="pagination-info">
            Affichage de {{ filteredPayments.length }} paiement(s)
          </div>
        </div>
      </div>
    </div>

    <!-- Panneau lat√©ral avec analyses -->
    <aside class="side-panel">
      
      <!-- Breakdown par m√©thode de paiement -->
      <div class="card breakdown-card">
        <div class="card-header">
          <h3>R√©partition par mode</h3>
        </div>
        <div class="card-body">
          <div class="breakdown-list">
            <div 
              *ngFor="let method of methodBreakdown" 
              class="breakdown-item"
              [style.--percentage]="method.percentage + '%'">
              <div class="breakdown-header">
                <span class="method-name">{{ method.method }}</span>
                <span class="method-amount">{{ formatCurrency(method.amount) }}</span>
              </div>
              <div class="breakdown-bar">
                <div class="breakdown-fill" [style.width.%]="method.percentage"></div>
              </div>
              <div class="breakdown-meta">
                <span>{{ method.count }} paiement(s)</span>
                <span>{{ formatPercentage(method.percentage) }}</span>
              </div>
            </div>
            <div *ngIf="methodBreakdown.length === 0" class="empty-breakdown">
              <p>Aucune donn√©e disponible</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Paiements r√©cents -->
      <div class="card recent-payments-card">
        <div class="card-header">
          <h3>Derniers encaissements</h3>
        </div>
        <div class="card-body">
          <div class="recent-list">
            <div 
              *ngFor="let payment of recentPayments" 
              class="recent-item"
              (click)="viewPaymentDetails(payment)">
              <div class="recent-avatar">
                {{ getInitials(payment.tenantName) }}
              </div>
              <div class="recent-content">
                <strong>{{ payment.tenantName }}</strong>
                <p>{{ payment.period }} ‚Ä¢ {{ formatCurrency(payment.amount) }}</p>
              </div>
              <span class="status-badge small" [ngClass]="payment.statusClass">
                {{ payment.statusText }}
              </span>
            </div>
            <div *ngIf="recentPayments.length === 0" class="empty-recent">
              <p>Aucun paiement r√©cent</p>
            </div>
          </div>
        </div>
      </div>

      <!-- R√©sum√© par p√©riode -->
      <div class="card period-summary-card">
        <div class="card-header">
          <h3>Par p√©riode</h3>
        </div>
        <div class="card-body">
          <div class="period-list">
            <div *ngFor="let period of periodTotals" class="period-item">
              <div class="period-header">
                <strong>{{ period.period }}</strong>
                <span>{{ formatCurrency(period.amount) }}</span>
              </div>
              <div class="period-details">
                <span>{{ period.paymentCount }} paiement(s)</span>
                <span class="commission">-{{ formatCurrency(period.commission) }}</span>
              </div>
              <div class="period-net">
                <strong>Net: {{ formatCurrency(period.netAmount) }}</strong>
              </div>
            </div>
            <div *ngIf="periodTotals.length === 0" class="empty-periods">
              <p>Aucune donn√©e par p√©riode</p>
            </div>
          </div>
        </div>
      </div>

    </aside>
  </section>

  <!-- Toast notifications -->
  <div class="toast-container" [class.show]="showToast">
    <div class="toast" [ngClass]="toastType">
      {{ toastMessage }}
    </div>
  </div>
</div>