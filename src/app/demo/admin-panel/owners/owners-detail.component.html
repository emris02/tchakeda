<div class="page-container">
  
    <button class="btn  back-btn" (click)="back()">
      &lt;
    </button>
    <h4 class="page-title">Détail du propriétaire</h4>

  <!-- Modal de suppression -->
  <div *ngIf="showDeleteConfirm" class="modal-overlay">
    <div class="modal-card">
      <h5>Confirmer la suppression</h5>
      <p>Voulez-vous vraiment supprimer ce propriétaire ? Cette action est irréversible.</p>
      <div class="form-actions">
        <button type="button" class="btn btn-light" (click)="showDeleteConfirm = false">Annuler</button>
        <button type="button" class="btn btn-danger" (click)="deleteOwner()">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Modal d'expulsion de locataire -->
  <div *ngIf="showEvictionModal" class="modal-overlay">
    <div class="modal-card large">
      <h5>Avis d'expulsion</h5>
      <p class="warning-text">
        <i class="fas fa-exclamation-triangle"></i>
        Vous êtes sur le point d'expulser un locataire. Veuillez remplir les informations ci-dessous.
      </p>
      
      <div class="eviction-info">
        <h6>Informations sur l'expulsion :</h6>
        <div class="info-item">
          <label>Appartement :</label>
          <span>{{ selectedApartmentForEviction?.name || '-' }}</span>
        </div>
        <div class="info-item">
          <label>Locataire :</label>
          <span>{{ selectedApartmentForEviction?.tenant ? getTenantFullNameSafe(selectedApartmentForEviction) : '-' }}</span>
        </div>
        <div class="info-item">
          <label>Bâtiment :</label>
          <span>{{ getBuildingName(selectedApartmentForEviction?.buildingId) || '-' }}</span>
        </div>
      </div>

      <div class="form-group">
        <label for="evictionReason">Raison de l'expulsion <span class="required">*</span></label>
        <textarea 
          id="evictionReason" 
          [(ngModel)]="evictionReason" 
          class="form-control" 
          rows="4" 
          placeholder="Veuillez expliquer la raison de l'expulsion (non-paiement, comportement, etc.)..."
          required></textarea>
        <div class="error" *ngIf="errors.evictionReason">
          <i class="fas fa-exclamation-circle"></i> {{ errors.evictionReason }}
        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" [(ngModel)]="acceptEvictionConditions" />
          Je confirme que j'ai le droit d'expulser ce locataire et que toutes les procédures légales ont été respectées
        </label>
        <div class="error" *ngIf="errors.evictionConditions">
          <i class="fas fa-exclamation-circle"></i> {{ errors.evictionConditions }}
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-light" (click)="closeEvictionModal()">Annuler</button>
        <button type="button" class="btn btn-danger" (click)="confirmEviction()" [disabled]="!acceptEvictionConditions || !evictionReason">
          Confirmer l'expulsion
        </button>
      </div>
    </div>
  </div>

  <!-- Section 1: Informations personnelles -->
  <div class="form-card">
    <div class="card-header">
      <h5>Informations du propriétaire</h5>
      <div class="action-buttons">
        <ng-container *ngIf="!editMode">
          <button class="action-btn edit" (click)="enableEdit()" title="Modifier les informations">
            <i class="fas fa-edit"></i>
          </button>
          <button class="action-btn delete" title="Supprimer le propriétaire" (click)="confirmDeleteOwner()">
            <i class="fas fa-trash"></i>
          </button>
        </ng-container>
        <ng-container *ngIf="editMode">
          <button class="action-btn save" type="submit" title="Valider les modifications" (click)="save()">
            <i class="fas fa-check"></i>
          </button>
        </ng-container>
      </div>
    </div>

    <!-- Mode édition -->
    <form *ngIf="editMode" (ngSubmit)="save()" class="form-grid">
      <div class="form-group">
        <div class="input-container">
          <input type="text" id="name" [(ngModel)]="form.name" name="name" class="underline-input" required placeholder="Nom complet" />
          <label for="name" class="label">
            <i class="fas fa-user"></i>
            Nom complet
          </label>
        </div>
        <div class="error" *ngIf="errors.name"><i class="fas fa-exclamation-circle"></i> {{ errors.name }}</div>
      </div>

      <div class="form-group">
        <div class="input-container">
          <input type="text" id="country" [(ngModel)]="form.country" name="country" class="underline-input" required placeholder="Pays" />
          <label for="country" class="label">
            <i class="fas fa-globe"></i>
            Pays
          </label>
        </div>
        <div class="error" *ngIf="errors.country"><i class="fas fa-exclamation-circle"></i> {{ errors.country }}</div>
      </div>

      <div class="form-group">
        <div class="input-container">
          <input type="text" id="phone" [(ngModel)]="form.phone" name="phone" class="underline-input" required placeholder="Téléphone" />
          <label for="phone" class="label">
            <i class="fas fa-phone"></i>
            Téléphone
          </label>
        </div>
        <div class="error" *ngIf="errors.phone"><i class="fas fa-exclamation-circle"></i> {{ errors.phone }}</div>
      </div>

      <div class="form-group">
        <div class="input-container">
          <input type="text" id="adress" [(ngModel)]="form.adress" name="adress" class="underline-input" required placeholder="Adresse" />
          <label for="adress" class="label">
            <i class="fas fa-map-marker-alt"></i>
            Adresse
          </label>
        </div>
        <div class="error" *ngIf="errors.adress"><i class="fas fa-exclamation-circle"></i> {{ errors.adress }}</div>
      </div>

      <div class="form-group">
        <div class="input-container">
          <input type="email" id="email" [(ngModel)]="form.email" name="email" class="underline-input" required placeholder="Email" />
          <label for="email" class="label">
            <i class="fas fa-envelope"></i>
            Email
          </label>
        </div>
        <div class="error" *ngIf="errors.email"><i class="fas fa-exclamation-circle"></i> {{ errors.email }}</div>
      </div>

      <div class="form-group">
        <input type="text" id="profession" [(ngModel)]="form.profession" name="profession" class="underline-input" placeholder="Profession" />
        <label for="profession" class="label">Profession</label>
      </div>
    </form>

    <!-- Mode visualisation -->
    <div *ngIf="!editMode" class="details-grid">
      <div class="form-group">
        <label><i class="fas fa-user"></i> Nom complet</label>
        <p>{{ owner?.name || '-' }}</p>
      </div>

      <div class="form-group">
        <label class=""><i class="fas fa-globe"></i> Pays</label>
        <p>{{ owner?.country || '-' }}</p>
      </div>

      <div class="form-group">
        <label><i class="fas fa-phone"></i> Téléphone</label>
        <p>{{ owner?.phone || '-' }}</p>
      </div>

      <div class="form-group">
        <label><i class="fas fa-map-marker-alt"></i> Adresse</label>
        <p>{{ owner?.adress || '-' }}</p>
      </div>

      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email</label>
        <p>{{ owner?.email || '-' }}</p>
      </div>

      <div class="form-group">
        <label><i class="fas fa-briefcase"></i> Profession</label>
        <p>{{ owner?.profession || '-' }}</p>
      </div>
    </div>
  </div>

  <!-- Section 2: Données du propriétaire (bâtiments, appartements, factures) -->
  <div class="form-card">
    <div class="card-header">
      <h5>Données du propriétaire</h5>
    </div>

    <div class="owner-data-flex">
      <!-- Colonne gauche : bâtiments -->
      <div class="owner-buildings-list">
        <h6 class="section-subtitle">Mes bâtiments</h6>
        <div *ngFor="let building of buildings" 
             (click)="selectBuilding(building)" 
             [ngClass]="{'selected-building': selectedBuilding?.id === building.id}" 
             class="building-card">
          <div class="building-name">{{ building.name }}</div>
          <div class="building-address">{{ building.address }}</div>
          <div class="building-city">{{ building.city }}</div>
        </div>
        <div *ngIf="buildings.length === 0" class="no-data">
          Aucun bâtiment enregistré
        </div>
      </div>

      <!-- Colonne droite : tableau -->
      <div class="owner-data-content">
        <div class="owner-table-tabs">
          <button class="tab-btn" [class.active-tab]="activeTab === 'appartements'" (click)="activeTab = 'appartements'">
            Appartements
          </button>
          <button class="tab-btn" [class.active-tab]="activeTab === 'factures'" (click)="activeTab = 'factures'">
            Factures
          </button>
        </div>

        <div class="tab-content" *ngIf="activeTab === 'appartements'">
          <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Appartement</th>
                <th>Locataire</th>
                <th>Mensualité</th>
                <th>Date de paiement</th>
                <th>Recouvreur</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let apt of selectedBuildingApartments">
                <!-- Nom de l'appart -->
                <td>{{ apt.name || '-' }}</td>

              <!-- Locataire -->
            <td>{{ getTenantFullName(apt) }}</td>

                <!-- Mensualité -->
            <td>{{ getMonthlyRent(apt) ? (getMonthlyRent(apt) | currency:'XOF':'symbol':'1.0') : '-' }}</td>

                <!-- Date de paiement -->
            <td>{{ getPaymentDate(apt) }}</td>

                <!-- Recouvreur -->
            <td>{{ getCollector(apt) }}</td>

                <!-- Statut -->
                <td>
                  <span class="status-badge">{{ getStatus(apt) }}</span>
                </td>

                <!-- Actions -->
                <td>
                  <button 
                    *ngIf="getStatus(apt) === 'Occupé' && getActiveRentalForApartment(apt.id)" 
                    class="btn btn-sm btn-danger" 
                    (click)="openEvictionModal(apt)" 
                    title="Expulser le locataire"
                    style="display: inline-block;">
                    <i class="fas fa-user-times"></i> Expulser
                  </button>
                  <span *ngIf="!(getStatus(apt) === 'Occupé' && getActiveRentalForApartment(apt.id))" class="text-muted">-</span>
                </td>
              </tr>
              <!-- Message si aucun appartement -->
              <tr *ngIf="selectedBuildingApartments.length === 0">
                <td colspan="7" class="no-data">
                  Aucun appartement pour ce bâtiment
                </td>
              </tr>
            </tbody>
          </table>

          </div>
        </div>

        <div class="tab-content" *ngIf="activeTab === 'factures'">
          <!-- Filtres de statut pour les factures -->
          <div class="invoice-status-filters">
            <button 
              class="status-filter-btn" 
              [class.active]="!invoiceStatusFilter || invoiceStatusFilter === ''"
              (click)="invoiceStatusFilter = ''; applyInvoiceFilters()">
              <i class="fas fa-list"></i> Toutes
            </button>
            <button 
              class="status-filter-btn status-paid" 
              [class.active]="invoiceStatusFilter === 'Payée'"
              (click)="invoiceStatusFilter = 'Payée'; applyInvoiceFilters()">
              <i class="fas fa-check-circle"></i> Payée
            </button>
            <button 
              class="status-filter-btn status-pending" 
              [class.active]="invoiceStatusFilter === 'En attente'"
              (click)="invoiceStatusFilter = 'En attente'; applyInvoiceFilters()">
              <i class="fas fa-clock"></i> En attente
            </button>
            <button 
              class="status-filter-btn status-unpaid" 
              [class.active]="invoiceStatusFilter === 'Impayée'"
              (click)="invoiceStatusFilter = 'Impayée'; applyInvoiceFilters()">
              <i class="fas fa-times-circle"></i> Impayée
            </button>
          </div>
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>N° Facture</th>
                  <th>Appartement</th>
                  <th>Locataire</th>
                  <th>Période</th>
                  <th>Loyer</th>
                  <th>Statut</th>
                  <th>Date paiement</th>
                  <th>Observations</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let facture of filteredInvoices">
                  <td>{{ facture.invoiceNumber || '-' }}</td>
                  <td>{{ facture.apartmentName || '-' }}</td>
                  <td>{{ facture.tenantName || '-' }}</td>
                  <td>{{ facture.period || '-' }}</td>
                  <td>{{ facture.price ? (facture.price | number:'1.0-0') + ' FCFA' : '-' }}</td>
                  <td>
                    <span class="status-badge" [ngClass]="{
                      'status-paid': facture.status === 'Payée',
                      'status-pending': facture.status === 'En attente',
                      'status-unpaid': facture.status === 'Impayée'
                    }">
                      {{ facture.status || '-' }}
                    </span>
                  </td>
                  <td>{{ facture.paymentDate ? (facture.paymentDate | date:'dd/MM/yyyy') : '-' }}</td>
                  <td>{{ facture.observations || '-' }}</td>
                </tr>
                <tr *ngIf="filteredInvoices.length === 0">
                  <td colspan="8" class="no-data">Aucune facture pour ce bâtiment</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>